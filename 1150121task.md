# 超音波成像軟體優化任務清單

**建立日期：** 2026-01-21 (民國 115 年 1 月 21 日)  
**專案目標：** 頂尖超音波成像軟體  
**參考設計：** SonoView Pro v5.1 UI

---

## 📋 任務總覽

| 階段 | 功能模組 | 預估工時 | 狀態 |
|------|----------|----------|------|
| Phase 1 | 非同步載入 + 進度條 | 3-5 天 | ✅ 已完成 |
| Phase 1 | 多視窗佈局 | 3-5 天 | ✅ 已完成 |
| Phase 2 | 病患研究瀏覽器 | 5-7 天 | 🔲 待開始 |
| Phase 2 | 進階回放控制 | 3-5 天 | 🔲 待開始 |
| Phase 3 | 臨床量測工具 | 7-10 天 | 🔲 待開始 |
| Phase 3 | 專業報告匯出 | 5-7 天 | 🔲 待開始 |
| Phase 4 | MPR 多平面重建 | 10-14 天 | 🔲 待開始 |
| Phase 4 | 3D 體積渲染 | 14-21 天 | 🔲 待開始 |

---

## Phase 1：架構與效能 (Architecture & Performance)

### 1.1 非同步 DICOM 載入

**優先級：** 🔴 高  
**複雜度：** ⭐⭐ 中等  
**影響檔案：** `src/pipelines.py`, `src/qt_gui.py`

#### 任務項目

- [x] **1.1.1** 建立 `src/loaders/` 模組目錄結構
  - [x] `__init__.py`
  - [x] `base_loader.py` - 抽象載入器基類 (merged into dicom_loader.py)
  - [x] `dicom_loader.py` - DICOM 專用載入器
  - [x] `video_loader.py` - 影片載入器

- [x] **1.1.2** 實作 `DicomLoadWorker(QThread)`
  - [x] 定義信號：`progress(int)`, `finished(object)`, `error(str)`
  - [x] 實作可中斷的載入邏輯
  - [x] 逐幀解壓縮時回報進度

- [x] **1.1.3** 實作進度對話框
  - [x] 建立 `LoadProgressDialog` 類別
  - [x] 顯示載入進度百分比
  - [x] 顯示目前處理階段（讀取/解壓縮/建立管道）
  - [x] 實作取消按鈕功能

- [x] **1.1.4** 整合至 `UltrasoundViewerWindow`
  - [x] 修改 `load_file()` 使用非同步載入
  - [x] 載入中禁用工具列
  - [x] 載入完成後恢復 UI 狀態

- [x] **1.1.5** 測試與驗證
  - [x] 測試大型壓縮 DICOM (>500 幀)
  - [x] 測試取消功能
  - [x] 驗證現有功能不受影響（縮放/平移/標註/LUT）

### 1.2 記憶體優化

**優先級：** 🟡 中  
**複雜度：** ⭐⭐⭐ 中高

#### 任務項目

- [ ] **1.2.1** 分析目前記憶體使用狀況
  - [ ] 使用 memory_profiler 分析載入流程
  - [ ] 記錄不同大小檔案的記憶體峰值

- [ ] **1.2.2** 實作 LRU 快取機制
  - [ ] 設計幀快取策略（前後各 N 幀）
  - [ ] 實作快取淘汰邏輯

- [ ] **1.2.3** 評估記憶體映射 (mmap) 方案
  - [ ] 原型測試 mmap 讀取效能
  - [ ] 評估與 FAST 的相容性

---

## Phase 1：工作流程與介面 (Workflow & UX)

### 1.3 多視窗佈局

**優先級：** 🔴 高  
**複雜度：** ⭐⭐⭐ 中高  
**影響檔案：** `src/qt_gui.py`, 新增 `src/viewport.py`

#### 任務項目

- [x] **1.3.1** 設計 `Viewport` 類別
  - [x] 封裝 FAST View 及相關元件
  - [x] 管理單一視窗的 pipeline
  - [x] 支援獨立載入檔案

- [x] **1.3.2** 設計 `ViewportManager` 類別
  - [x] 管理多個 Viewport 實例
  - [x] 實作佈局切換 (1x1, 1x2, 2x1, 2x2)
  - [x] 追蹤活動視窗

- [x] **1.3.3** 佈局切換 UI
  - [x] 影像區域右上角浮動佈局按鈕組
  - [x] 按鈕圖示設計（1x1, 1x2, 2x1, 2x2）
  - [x] 當前佈局高亮顯示
  - [x] 滑鼠懸停時顯示 tooltip
  - [x] 快捷鍵支援 (Ctrl+1/2/3/4)

- [x] **1.3.4** 整合至 `UltrasoundViewerWindow`
  - [x] 替換單一 FAST View 為 ViewportManager
  - [x] 相容性參考同步 (_sync_viewport_references)
  - [x] 更新載入流程使用 Viewport

- [x] **1.3.5** 測試與驗證
  - [x] 測試佈局切換
  - [x] 測試多視窗載入不同檔案
  - [x] 測試活動視窗切換（App-level Event Filter）
  - [x] 驗證縮放/平移/標註在多視窗下正常

---

## Phase 2：工作流程與介面 (Workflow & UX)

### 2.1 病患研究瀏覽器 (Study Browser)

**優先級：** 🔴 高  
**複雜度：** ⭐⭐⭐ 中高  
**影響檔案：** `src/qt_gui.py` (`FileListWidget`)

#### 任務項目

- [ ] **2.1.1** 升級 `FileListWidget` 為階層式
  - [ ] 改用 `QTreeView` + `QStandardItemModel`
  - [ ] 設計資料結構：Patient → Study → Series

- [ ] **2.1.2** DICOM 階層解析
  - [ ] 從 DICOM 標籤提取 Patient/Study/Series 資訊
  - [ ] 自動歸類同一病患的檔案

- [ ] **2.1.3** 縮圖預覽
  - [ ] 產生 Series 代表幀縮圖
  - [ ] 快取縮圖避免重複產生

- [ ] **2.1.4** 搜尋與篩選
  - [ ] 新增搜尋框（病患姓名/ID）
  - [ ] 日期範圍篩選

### 2.2 進階回放控制

**優先級：** 🟡 中  
**複雜度：** ⭐⭐ 中等  
**影響檔案：** `src/qt_gui.py` (`PlaybackControlWidget`)

#### 任務項目

- [ ] **2.2.1** 擴展播放模式
  - [ ] Loop 循環（現有）
  - [ ] Rock/Yoyo 來回循環
  - [ ] Play Once 單次播放

- [ ] **2.2.2** 變速播放
  - [ ] 速度選項：0.25x, 0.5x, 1x, 2x, 4x
  - [ ] 速度顯示標籤

- [ ] **2.2.3** 精確幀控制
  - [ ] 上一幀/下一幀按鈕 `[<]` `[>]`
  - [ ] 鍵盤快捷鍵支援（← →）
  - [ ] 跳轉至指定幀

- [ ] **2.2.4** 時間軸增強
  - [ ] Loop 區間標記（設定循環起止點）
  - [ ] 顯示時間碼 (mm:ss.ff)

---

## Phase 3：臨床量測工具 (Clinical Measurement Tools)

### 3.1 進階生物測量

**優先級：** 🟡 中  
**複雜度：** ⭐⭐⭐ 中高  
**影響檔案：** `src/annotations.py`, 新增 `src/measurements/`

#### 任務項目

- [ ] **3.1.1** 建立 `src/measurements/` 模組
  - [ ] `__init__.py`
  - [ ] `base.py` - 量測基類
  - [ ] `formulas.py` - 醫學計算公式庫

- [ ] **3.1.2** 產科量測 (`obstetric.py`)
  - [ ] CRL (Crown-Rump Length) + 孕週推算
  - [ ] BPD (Biparietal Diameter)
  - [ ] FL (Femur Length)
  - [ ] AC (Abdominal Circumference) - 橢圓工具
  - [ ] EFW (Estimated Fetal Weight) 自動計算

- [ ] **3.1.3** 心臟科量測 (`cardiac.py`)
  - [ ] LVID (Left Ventricular Internal Diameter)
  - [ ] LV Volume (Simpson's / Teichholz)
  - [ ] EF (Ejection Fraction) 計算
  - [ ] FS (Fractional Shortening)

- [ ] **3.1.4** UI 整合
  - [ ] 量測工具選單分類（通用/產科/心臟）
  - [ ] 量測結果面板
  - [ ] 公式選擇對話框

### 3.2 專業報告匯出

**優先級：** 🟡 中  
**複雜度：** ⭐⭐⭐ 中高

#### 任務項目

- [ ] **3.2.1** PDF 報告
  - [ ] 選擇報告庫：`reportlab` 或 `weasyprint`
  - [ ] 設計報告模板
  - [ ] 包含：病患資訊、影像截圖、量測結果

- [ ] **3.2.2** DICOM SR (Structured Report)
  - [ ] 使用 `pydicom` 建立 SR 物件
  - [ ] 符合 DICOM SR 標準格式

- [ ] **3.2.3** 報告模板系統
  - [ ] 可自訂欄位
  - [ ] 支援醫院 Logo

---

## Phase 4：進階影像功能 (Advanced Imaging)

### 4.1 多平面重建 (MPR)

**優先級：** 🟡 中  
**複雜度：** ⭐⭐⭐⭐ 高

#### 任務項目

- [ ] **4.1.1** 3D 資料載入
  - [ ] 支援多幀 DICOM 轉 3D Volume
  - [ ] 處理 Spacing 資訊

- [ ] **4.1.2** MPR 切片提取
  - [ ] Axial（橫斷面）切片
  - [ ] Coronal（冠狀面）切片
  - [ ] Sagittal（矢狀面）切片
  - [ ] 斜向切片（Oblique）

- [ ] **4.1.3** MPR 視圖整合
  - [ ] 2x2 佈局顯示三視圖 + 參考
  - [ ] 交叉參考線同步
  - [ ] 滾輪切片瀏覽

### 4.2 3D 體積渲染 (Volume Rendering)

**優先級：** 🟢 低  
**複雜度：** ⭐⭐⭐⭐⭐ 很高

#### 任務項目

- [ ] **4.2.1** 技術評估
  - [ ] 評估 FAST `VolumeRenderer`
  - [ ] 評估 VTK 整合方案
  - [ ] 評估 PyVista 方案

- [ ] **4.2.2** 基礎渲染
  - [ ] Ray Casting 實作
  - [ ] 色彩傳遞函數 (Color Transfer Function)
  - [ ] 透明度傳遞函數 (Opacity Transfer Function)

- [ ] **4.2.3** 互動控制
  - [ ] 3D 旋轉/縮放
  - [ ] 裁切平面 (Clipping Plane)
  - [ ] 預設視角（前/後/左/右/上/下）

- [ ] **4.2.4** 效能優化
  - [ ] GPU 加速
  - [ ] LOD (Level of Detail)

---

## 📁 建議的新增目錄結構

```
src/
├── loaders/                 # Phase 1: 非同步載入
│   ├── __init__.py
│   ├── base_loader.py
│   ├── dicom_loader.py
│   └── video_loader.py
├── measurements/            # Phase 3: 臨床量測
│   ├── __init__.py
│   ├── base.py
│   ├── obstetric.py
│   ├── cardiac.py
│   └── formulas.py
├── rendering/               # Phase 4: 3D 渲染
│   ├── __init__.py
│   ├── volume_renderer.py
│   ├── transfer_function.py
│   └── mpr_viewer.py
└── reports/                 # Phase 3: 報告匯出
    ├── __init__.py
    ├── pdf_generator.py
    └── dicom_sr.py
```

---

## 📝 備註

- 每個子任務完成後，在 `[ ]` 中填入 `x` 變成 `[x]`
- 遇到問題可在任務項目下方加入備註
- 預估工時僅供參考，實際可能因技術難度調整

---

## 📅 更新紀錄

| 日期 | 更新內容 |
|------|----------|
| 2026-01-21 | 建立初始任務清單 |
| 2026-01-21 | 完成 1.1 非同步 DICOM 載入 (1.1.1-1.1.4) |
| 2026-01-21 | 1.1.5 測試驗證通過 ✅ |
| 2026-01-21 | 完成 1.3 多視窗佈局 (1.3.1-1.3.4)，待測試 |

